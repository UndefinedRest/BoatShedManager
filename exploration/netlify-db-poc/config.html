<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Configuration - Netlify DB POC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e40af 0%, #0ea5e9 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #1e40af;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            color: #64748b;
            font-size: 14px;
        }

        .badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        /* Login Screen */
        .login-screen {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: 100px auto;
        }

        .login-screen h2 {
            color: #1e40af;
            margin-bottom: 20px;
            text-align: center;
        }

        .login-screen input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .login-screen button {
            width: 100%;
            padding: 12px;
            background: #0ea5e9;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Main Editor */
        .editor-container {
            display: none;
        }

        .editor-container.show {
            display: block;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .panel h2 {
            color: #1e40af;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .session-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .session-item {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .session-header input[type="text"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
        }

        .session-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .session-controls label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .session-times {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .time-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .time-input label {
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
        }

        .time-input input {
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn-delete {
            padding: 6px 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-add {
            width: 100%;
            padding: 12px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .preview-sessions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .preview-session {
            background: #0ea5e9;
            color: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }

        .preview-session.disabled {
            background: #94a3b8;
            opacity: 0.5;
        }

        .action-bar {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
        }

        .btn-primary {
            padding: 12px 24px;
            background: #0ea5e9;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-secondary {
            padding: 12px 24px;
            background: #64748b;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .status-message {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            display: none;
        }

        .status-message.show {
            display: block;
        }

        .status-message.success {
            background: #d1fae5;
            color: #059669;
        }

        .status-message.error {
            background: #fef2f2;
            color: #dc2626;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <h2>üîê Netlify DB POC</h2>
        <div id="loginError" class="error-message"></div>
        <input
            type="password"
            id="passwordInput"
            placeholder="Enter admin password"
            autocomplete="current-password"
        />
        <button onclick="login()">Login</button>
    </div>

    <!-- Editor Container -->
    <div id="editorContainer" class="editor-container">
        <div class="container">
            <div class="header">
                <h1>‚öôÔ∏è Session Configuration <span class="badge">Netlify DB POC</span></h1>
                <p>Testing Netlify DB (Neon PostgreSQL) for persistent session storage</p>
            </div>

            <div class="main-grid">
                <div class="panel">
                    <h2>üìã Sessions</h2>
                    <div id="sessionList" class="session-list"></div>
                    <button class="btn-add" onclick="addSession()">+ Add Session</button>
                </div>

                <div class="panel">
                    <h2>üëÅÔ∏è Preview</h2>
                    <div id="previewList" class="preview-sessions"></div>
                </div>
            </div>

            <div class="action-bar">
                <div class="action-buttons">
                    <button class="btn-primary" onclick="saveChanges()">üíæ Save to DB</button>
                    <button class="btn-secondary" onclick="resetChanges()">üîÑ Reset</button>
                </div>
                <div id="statusMessage" class="status-message"></div>
            </div>
        </div>
    </div>

    <script>
        let adminPassword = '';
        let sessions = [];
        let originalSessions = [];

        async function login() {
            const passwordInput = document.getElementById('passwordInput');
            const password = passwordInput.value.trim();
            const errorDiv = document.getElementById('loginError');

            if (!password) {
                showLoginError('Please enter a password');
                return;
            }

            adminPassword = password;

            try {
                await loadSessions();
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('editorContainer').classList.add('show');
            } catch (error) {
                showLoginError(error.message);
                adminPassword = '';
            }
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        async function loadSessions() {
            const response = await fetch('/.netlify/functions/sessions');

            if (!response.ok) {
                throw new Error('Failed to load sessions from database');
            }

            const data = await response.json();
            sessions = JSON.parse(JSON.stringify(data.sessions));
            originalSessions = JSON.parse(JSON.stringify(data.sessions));

            renderSessions();
            renderPreview();
        }

        function renderSessions() {
            const container = document.getElementById('sessionList');
            container.innerHTML = '';

            sessions.forEach((session, index) => {
                const div = document.createElement('div');
                div.className = 'session-item';
                div.innerHTML = `
                    <div class="session-header">
                        <input
                            type="text"
                            value="${session.label}"
                            onchange="updateSessionLabel(${index}, this.value)"
                        />
                        <div class="session-controls">
                            <label>
                                <input
                                    type="checkbox"
                                    ${session.enabled ? 'checked' : ''}
                                    onchange="toggleSession(${index})"
                                />
                                Enabled
                            </label>
                        </div>
                    </div>
                    <div class="session-times">
                        <div class="time-input">
                            <label>Start Time</label>
                            <input
                                type="time"
                                value="${session.startTime}"
                                onchange="updateSessionTime(${index}, 'startTime', this.value)"
                            />
                        </div>
                        <div class="time-input">
                            <label>End Time</label>
                            <input
                                type="time"
                                value="${session.endTime}"
                                onchange="updateSessionTime(${index}, 'endTime', this.value)"
                            />
                        </div>
                    </div>
                    <button class="btn-delete" onclick="deleteSession(${index})">üóëÔ∏è Delete</button>
                `;
                container.appendChild(div);
            });
        }

        function renderPreview() {
            const container = document.getElementById('previewList');
            container.innerHTML = '';

            const enabledSessions = sessions.filter(s => s.enabled);

            enabledSessions.forEach(session => {
                const div = document.createElement('div');
                div.className = 'preview-session';
                div.textContent = session.display || formatTimeDisplay(session.startTime, session.endTime);
                container.appendChild(div);
            });
        }

        function updateSessionLabel(index, value) {
            sessions[index].label = value;
        }

        function updateSessionTime(index, field, value) {
            sessions[index][field] = value;
            sessions[index].display = formatTimeDisplay(sessions[index].startTime, sessions[index].endTime);
            renderSessions();
            renderPreview();
        }

        function toggleSession(index) {
            sessions[index].enabled = !sessions[index].enabled;
            renderSessions();
            renderPreview();
        }

        function deleteSession(index) {
            if (sessions.length === 1) {
                alert('Cannot delete the last session');
                return;
            }
            if (confirm(`Delete "${sessions[index].label}"?`)) {
                sessions.splice(index, 1);
                renderSessions();
                renderPreview();
            }
        }

        function addSession() {
            sessions.push({
                id: `session-${Date.now()}`,
                label: `New Session ${sessions.length + 1}`,
                startTime: '09:00',
                endTime: '10:00',
                display: '9:00 AM - 10:00 AM',
                enabled: true,
                sortOrder: sessions.length
            });
            renderSessions();
            renderPreview();
        }

        function resetChanges() {
            if (confirm('Discard all changes?')) {
                sessions = JSON.parse(JSON.stringify(originalSessions));
                renderSessions();
                renderPreview();
            }
        }

        async function saveChanges() {
            try {
                const response = await fetch('/.netlify/functions/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminPassword}`
                    },
                    body: JSON.stringify({ sessions })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to save');
                }

                originalSessions = JSON.parse(JSON.stringify(sessions));
                showStatus('‚úÖ Saved to Netlify DB!', 'success');
            } catch (error) {
                showStatus('‚ùå Error: ' + error.message, 'error');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message show ${type}`;
            setTimeout(() => statusDiv.classList.remove('show'), 5000);
        }

        function formatTimeDisplay(startTime, endTime) {
            const formatTime = (time) => {
                const [hours, minutes] = time.split(':');
                const hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
                return `${displayHour}:${minutes} ${ampm}`;
            };
            return `${formatTime(startTime)} - ${formatTime(endTime)}`;
        }

        document.getElementById('passwordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });
    </script>
</body>
</html>
